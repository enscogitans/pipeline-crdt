## Интерфейс взаимодействия

Это файл [service.py](./service.py)
* `make_initial_crdt_graph` по тексту yaml файла генерирует CRDT граф
* `build_local_updates` принимает оригинальную версию yaml файла и две его модификации, сделанные разными пользователями (во всех случаях текст этих файлов). Возвращает список обновлений CRDT графа 
* `apply_updates` принимает CRDT граф для редактирования, список обновлений и список id обновлений, которые следует пропустить. Граф редактируется inplace, но функция его всё равно возвращает
* `convert_to_yaml` принимает CRDT граф и конвертирует его в yaml файл. Возвращает текст этого файла
* `merge_with_empty_graph` функция, которая осуществляет простейшую комбинацию всех операций выше. 
Принимает оригинальную версию yaml файла и две его модификации.
Возвращает текст объединённого yaml файла в предположении, что CRDT граф нужно создать с нуля, используя оригинальный yaml файл.


## Структура проекта

### Модуль [yaml_graph](./yaml_graph)

Осуществляет работу с yaml файлом и с yaml графом.

* [nodes.py](./yaml_graph/nodes.py) описывает вершины yaml графа
* [serialization.py](./yaml_graph/serialization.py) позволяет сконвертировать yaml файл в yaml граф и обратно. Yaml файл читается с помощью библиотеки [ruamel](https://yaml.readthedocs.io/en/latest/)
* [updates.py](./yaml_graph/updates.py) описывает элементарные обновления yaml графа
* [updates_builder.py](./yaml_graph/updates_builder.py) позволяет по двум yaml графам построить их дельту: набор элементарных операций, переводящих первый граф во второй. Используется библиотека 
[deepdiff](https://deepdiff.readthedocs.io/en/latest/). 
  * Библиотека была полезной на первых этапах, но в дальнейшем начали появляться сложности в том, чтобы удобно находить соответствие между элементами сравниваемых списков.
  
    TODO: перейти на собственную реализацию построения дельты 


### Модуль [crdt_graph](./crdt_graph)

Осуществляет работу с CRDT графом.

* [nodes.py](./crdt_graph/nodes.py) описывает вершины CRDT графа
* [graph.py](./crdt_graph/graph.py) хранит корневую вершину дерева и позволяет по индексироваться по его вершинам
* [updates.py](./crdt_graph/updates.py) описывает элементарные обновления CRDT графа
* [updates_applier.py](./crdt_graph/updates_applier.py) применяет к CRDT графу элементарные обновления 


### Модуль [converter](./converter)

Позволяет производить конвертацию между yaml графом и CRDT графом и между их обновлениями.

Конвертация из CRDT графа в yaml граф происходит с потерей информации. При конвертации из yaml графа в CRDT граф происходит добавление новой информации (например, id вершины и текущий timestamp).

* [yaml_to_crdt_updates.py](./converter/yaml_to_crdt_updates.py) конвертирует обновления yaml графа в обновления CRDT графа
* [new_yaml_node_to_crdt_node.py](./converter/new_yaml_node_to_crdt_node.py) конвертирует поддерево yaml графа в поддерево CRDT графа. Используется при конвертации обновления вида "добавить новую вершину"
* [crdt_to_yaml_node.py](./converter/crdt_to_yaml_node.py) конвертирует CRDT граф в yaml граф 


### Запуск тестов

Для запуска тестов нужно из правильной директории запустить: 

```bash
pytest .
```
